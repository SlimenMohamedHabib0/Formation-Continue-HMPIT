<div class="page-body cours-editor">
  <div class="page-header mb-4">
    <div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <h2 class="page-title mb-0">
          {{ isEdit ? 'Modifier le cours' : 'Créer un cours' }}
        </h2>

        <span *ngIf="course" class="badge" [ngClass]="badgeClass(course.etat)">
          {{ course.etat }}
        </span>
      </div>

      <div class="text-secondary">
        Renseignez les informations du cours. La catégorie est créée automatiquement si elle n’existe pas.
      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" type="button" (click)="back()">
        Retour
      </button>

      <button
        class="btn btn-primary"
        type="button"
        (click)="save()"
        [disabled]="loading || saving || (isEdit && !canEdit)"
      >
        Enregistrer
      </button>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger mb-3">
    {{ error }}
  </div>

  <div *ngIf="success" class="alert alert-success mb-3">
    {{ success }}
  </div>

  <div *ngIf="loading" class="card">
    <div class="card-body text-center py-6">
      <div class="spinner-border text-primary"></div>
    </div>
  </div>

  <div *ngIf="!loading" class="card">
    <div class="card-body">
      <div *ngIf="isEdit && course && !canEdit" class="alert alert-warning mb-3">
        Ce cours est publié. Les champs sont verrouillés tant qu’il n’est pas repassé en brouillon.
      </div>

      <div class="form-grid">
        <div class="form-col">
          <label class="form-label">Titre</label>
          <input class="form-control" [(ngModel)]="titre" [disabled]="saving || (isEdit && !canEdit)" />
        </div>

        <div class="form-col">
          <label class="form-label">Catégorie</label>
          <input
            class="form-control"
            [(ngModel)]="categoryName"
            [disabled]="saving || (isEdit && !canEdit)"
            (input)="onCategoryInput()"
            list="catList"
            placeholder="Ex: Cardiologie"
          />
          <datalist id="catList">
            <option *ngFor="let c of categories" [value]="c.libelle"></option>
          </datalist>
          <div class="text-secondary small mt-1" *ngIf="loadingCats">
            Chargement des catégories...
          </div>
        </div>

        <div class="form-col-full">
          <label class="form-label">Description</label>
          <textarea
            class="form-control"
            rows="5"
            [(ngModel)]="description"
            [disabled]="saving || (isEdit && !canEdit)"
          ></textarea>
        </div>

        <div class="form-col-full">
          <label class="form-label">Mots clés</label>
          <input
            class="form-control"
            [(ngModel)]="motsCles"
            [disabled]="saving || (isEdit && !canEdit)"
            placeholder="Ex: urgence, ECG, triage..."
          />
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isEdit" class="card mt-3" id="co-section">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <div class="section-title">Co-enseignants</div>
          <div class="text-secondary">Ajoutez des professeurs affectés à ce cours (brouillon uniquement).</div>
        </div>
      </div>

      <div *ngIf="coError" class="alert alert-warning mb-3">
        {{ coError }}
      </div>

      <div class="row g-3 align-items-end mb-3">
        <div class="col-12 col-md-7">
          <label class="form-label">Rechercher un professeur</label>
          <input
            class="form-control"
            [(ngModel)]="profTerm"
            (input)="onProfTermInput()"
            [disabled]="coLoading || profSearching || !canEdit"
            placeholder="Nom ou email..."
          />
        </div>

        <div class="col-12 col-md-5 d-flex gap-2 align-items-center">
          <div class="text-secondary small" *ngIf="profSearching">
            Recherche...
          </div>
          <div class="text-secondary small" *ngIf="coLoading">
            Chargement...
          </div>
        </div>
      </div>

      <div *ngIf="profResults.length" class="list-group mb-3">
        <button
          type="button"
          class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-3"
          *ngFor="let p of profResults"
          (click)="addCoTeacher(p)"
          [disabled]="!canEdit || alreadyAdded(p) || coLoading"
        >
          <div class="text-truncate">
            {{ p.fullName }} — {{ p.email }}
          </div>
          <span class="badge bg-secondary-lt" *ngIf="alreadyAdded(p)">Déjà ajouté</span>
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-vcenter">
          <thead>
            <tr>
              <th>Professeur</th>
              <th class="text-end" style="width: 180px">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="coLoading">
              <td colspan="2" class="text-center py-4">
                <div class="spinner-border text-primary"></div>
              </td>
            </tr>

            <tr *ngIf="!coLoading && !coProfessors.length">
              <td colspan="2" class="text-center text-secondary py-4">
                Aucun co-enseignant.
              </td>
            </tr>

            <tr *ngFor="let p of coProfessors">
              <td class="text-truncate">
                {{ p.fullName }} — {{ p.email }}
                <span *ngIf="isMe(p)" class="badge bg-azure-lt ms-2">Vous</span>
              </td>
              <td class="text-end">
                <button
                  class="btn btn-sm btn-outline-danger"
                  type="button"
                  (click)="removeCoTeacher(p)"
                  [disabled]="!canEdit || coLoading || isMe(p)"
                >
                  Retirer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="text-secondary small mt-2" *ngIf="!canEdit">
        Ce cours est publié, vous ne pouvez pas modifier les co-enseignants.
      </div>
    </div>
  </div>

  <div *ngIf="isEdit" class="card mt-3" id="video-section">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <div class="section-title">VIDÉO DU COURS</div>
          <div class="text-secondary">
            <span *ngIf="course?.videoFileName; else noVideo">{{ course?.videoFileName }}</span>
            <ng-template #noVideo>— Aucune vidéo attachée —</ng-template>
          </div>
        </div>
  
        <label class="btn btn-outline-primary mb-0" [class.disabled]="saving || !canEdit">
          Attacher vidéo
          <input
            type="file"
            accept="video/*"
            (change)="onVideoSelected($event)"
            hidden
            [disabled]="saving || !canEdit"
          />
        </label>
      </div>
  
      <div *ngIf="videoUrl; else noVideoPreview" class="video-wrap">
        <video  class="course-video" controls [src]="videoUrl"></video>
      </div>
  
      <ng-template #noVideoPreview>
        <div class="text-secondary">Aperçu indisponible.</div>
      </ng-template>
    </div>
  </div>
  

  <div *ngIf="isEdit" class="card mt-3" id="pdf-section">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
          <div class="section-title">PDF du cours</div>
          <div class="text-secondary">
            <span *ngIf="course?.nomFichierPdf; else noPdf">{{ course?.nomFichierPdf }}</span>
            <ng-template #noPdf>— Aucun PDF attaché —</ng-template>
          </div>
        </div>

        <label class="btn btn-outline-primary mb-0" [class.disabled]="saving || !canEdit">
          Attacher PDF
          <input
            type="file"
            accept="application/pdf"
            (change)="onPdfSelected($event)"
            hidden
            [disabled]="saving || !canEdit"
          />
        </label>
      </div>

      <div *ngIf="pdfUrl; else noPreview" class="pdf-frame-wrap">
        <iframe class="pdf-frame" [src]="pdfUrl"></iframe>
      </div>

      <ng-template #noPreview>
        <div class="text-secondary">Aperçu indisponible.</div>
      </ng-template>
    </div>
  </div>
</div>
